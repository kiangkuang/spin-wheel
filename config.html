<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wheel Configuration</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      .drag-handle {
        cursor: grab;
        color: var(--bs-secondary-color);
      }

      .dragging .drag-handle {
        cursor: grabbing;
      }

      .dragging {
        opacity: 0.95;
        background-color: var(--bs-secondary-bg);
        box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 15px;
        transform: translate(8px, -4px);
        transition: box-shadow 0.2s, transform 0.2s, background-color 0.2s;
      }

      .row {
        cursor: default;
        transition: box-shadow 0.2s, transform 0.2s, background-color 0.2s;
      }
    </style>
  </head>

  <body>
    <div id="app" class="container py-4">
      <h1>Wheel Configuration</h1>

      <div class="mb-4">
        <div
          v-for="(item, index) in items"
          :key="index"
          class="row g-2 pb-2 my-1 align-items-center rounded"
          :class="{ dragging: draggingIndex === index }"
        >
          <div class="col-1">
            <div
              class="drag-handle"
              draggable="true"
              @dragstart="dragStart($event, index)"
              @dragover.prevent
              @dragenter.prevent="dragEnter($event, index)"
              @dragend="dragEnd"
            >
              ⋮⋮
            </div>
          </div>
          <div class="col-11 col-md">
            <input
              v-model.trim="item.label"
              class="form-control"
              placeholder="Label"
            />
          </div>
          <div class="col offset-1 col-md-2 offset-md-0">
            <input
              v-model.trim="item.backgroundColor"
              class="form-control"
              placeholder="Color"
              list="colorOptions"
              :style="{ backgroundColor: item.backgroundColor, color: getContrastColor(item.backgroundColor) }"
            />
            <datalist id="colorOptions">
              <option value="red"></option>
              <option value="blue"></option>
              <option value="green"></option>
              <option value="yellow"></option>
              <option value="orange"></option>
              <option value="purple"></option>
              <option value="pink"></option>
              <option value="navy"></option>
              <option value="teal"></option>
              <option value="brown"></option>
            </datalist>
          </div>
          <div class="col-2">
            <input
              v-model.number="item.weight"
              type="number"
              class="form-control"
              min="1"
              placeholder="Weight"
            />
          </div>
          <div class="col-auto">
            <button @click="removeItem(index)" class="btn btn-danger w-100">
              ×
            </button>
          </div>
        </div>

        <button @click="addItem" class="btn btn-primary">Add Item</button>
      </div>

      <div>
        <div class="d-flex gap-2">
          <a :href="wheelUrl" class="btn btn-primary">Open Wheel</a>
          <button
            @click="copyUrl"
            class="btn btn-secondary"
            v-text="copyBtnText"
          ></button>
        </div>
        <div class="text-muted small mt-2">
          Consider using
          <a href="https://tinyurl.com/create.php" target="_blank">TinyURL</a>
          to shorten the long URL!
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, watchEffect } = Vue;

      createApp({
        setup() {
          const parseItemsFromUrl = () => {
            try {
              return JSON.parse(
                new URLSearchParams(window.location.search).get("items"),
              );
            } catch (e) {
              return null;
            }
          };

          const defaultItems = [
            { label: "Item 1", backgroundColor: "orange", weight: 2 },
            { label: "Item 2", backgroundColor: "navy", weight: 3 },
            { label: "Item 3", backgroundColor: "red", weight: 4 },
          ];

          const parsedItems = parseItemsFromUrl();
          const items = ref(
            !parsedItems || parsedItems.length === 0
              ? defaultItems
              : parsedItems,
          );

          const draggingIndex = ref(null);

          const copyBtnText = ref("Copy URL");

          const addItem = () => {
            items.value.push({
              label: `Item ${items.value.length + 1}`,
              backgroundColor:
                items.value.length >= 2
                  ? items.value[items.value.length - 2].backgroundColor
                  : "orange",
              weight: 1,
            });
          };

          const removeItem = (index) => {
            items.value.splice(index, 1);
          };

          const wheelUrl = computed(() => {
            const params = new URLSearchParams();
            params.set("items", JSON.stringify(items.value));
            return `index.html?${params.toString()}`;
          });

          const getContrastColor = (bgColor = "") => {
            // For common dark colors, return white
            const darkColors = [
              "navy",
              "blue",
              "purple",
              "red",
              "green",
              "brown",
              "black",
            ];
            if (darkColors.includes(bgColor.toLowerCase())) return "white";
            return "black";
          };

          const copyUrl = () => {
            navigator.clipboard.writeText(wheelUrl.value).then(() => {
              copyBtnText.value = "Copied!";
              setTimeout(() => {
                copyBtnText.value = "Copy URL";
              }, 2000);
            });
          };

          const dragStart = (e, index) => {
            draggingIndex.value = index;
            e.dataTransfer.effectAllowed = "move";
          };

          const dragEnter = (e, index) => {
            if (index === draggingIndex.value) return;

            // Reorder items
            const itemToMove = items.value[draggingIndex.value];
            items.value.splice(draggingIndex.value, 1);
            items.value.splice(index, 0, itemToMove);
            draggingIndex.value = index;
          };

          const dragEnd = () => {
            draggingIndex.value = null;
          };

          // Update URL when items change
          watchEffect(
            () => {
              const params = new URLSearchParams(window.location.search);
              params.set("items", JSON.stringify(items.value));
              const newUrl = `${window.location.pathname}?${params.toString()}`;
              history.replaceState(null, "", newUrl);
            },
            { deep: true },
          );

          return {
            items,
            addItem,
            removeItem,
            wheelUrl,
            getContrastColor,
            copyUrl,
            copyBtnText,
            dragStart,
            dragEnter,
            dragEnd,
            draggingIndex,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
